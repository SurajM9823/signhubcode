{% extends 'base_authenticated.html' %}
{% load static %}

{% block title %}Client Management - Advertisement Boards{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Header with Action Buttons -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Client Management</h1>
            <p class="text-gray-600 text-sm mt-1">Manage advertisement boards and client details</p>
        </div>
        <div class="flex items-center space-x-3 flex-wrap">
            <button id="add-municipality-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md font-medium transition-colors flex items-center space-x-2 text-sm">
                <i class="fas fa-plus"></i>
                <span>Add Municipality</span>
            </button>
            <button id="add-board-type-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium transition-colors flex items-center space-x-2 text-sm">
                <i class="fas fa-plus"></i>
                <span>Add Board Type</span>
            </button>
            <button id="set-rate-btn" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-md font-medium transition-colors flex items-center space-x-2 text-sm">
                <i class="fas fa-dollar-sign"></i>
                <span>Set Board Type Rate</span>
            </button>
            <button id="add-brand-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium transition-colors flex items-center space-x-2 text-sm">
                <i class="fas fa-plus"></i>
                <span>Add Brand</span>
            </button>
        </div>
    </div>

    <!-- Client Search -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6 border border-gray-100">
        <div class="flex flex-col sm:flex-row sm:space-x-4 gap-4">
            <div class="flex-1">
                <label for="client_id" class="block text-sm font-medium text-gray-700 mb-1">Client ID</label>
                <input type="text" id="client_id" placeholder="Enter client ID" 
                       class="block w-full px-3 py-2 border border-gray-200 rounded-md shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
            </div>
            <div class="flex-1 relative">
                <label for="client_name" class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                <input type="text" id="client_name" placeholder="Enter client name (e.g., NISS)" 
                       class="block w-full px-3 py-2 border border-gray-200 rounded-md shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                <div id="client-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-48 overflow-y-auto hidden">
                    <ul id="client-list" class="text-sm text-gray-700"></ul>
                </div>
            </div>
            <button id="search-client-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-medium py-2 px-4 rounded-md transition-colors flex items-center space-x-2 sm:mt-7">
                <i class="fas fa-search"></i>
                <span>Search</span>
            </button>
        </div>
        <div id="client-info" class="mt-4 p-4 bg-green-50 rounded-md border border-green-200 hidden">
            <div class="flex items-center space-x-2">
                <i class="fas fa-check-circle text-green-600"></i>
                <span class="text-sm font-medium text-green-800">Client Found:</span>
                <span id="client-name" class="text-sm font-semibold text-green-900"></span>
            </div>
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700">Total Boards: </span>
                    <span id="total-boards" class="font-semibold text-teal-600">0</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Previous Dues: NPR </span>
                    <span id="previous-dues" class="font-semibold text-red-600">0.00</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">This Year: NPR </span>
                    <span id="total-value" class="font-semibold text-green-600">0.00</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Total Dues: NPR </span>
                    <span id="total-dues" class="font-semibold text-red-600">0.00</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Total Discount: NPR </span>
                    <span id="total-discount" class="font-semibold text-purple-600">0.00</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Total Paid: NPR </span>
                    <span id="total-paid" class="font-semibold text-green-600">0.00</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Total Remaining: NPR </span>
                    <span id="total-remaining" class="font-semibold text-red-600">0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Board Details Form -->
    <div id="board-form-container" class="bg-white rounded-lg shadow-md p-6 mb-6 border border-gray-100 hidden">
        <h2 id="board-form-title" class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
            <i class="fas fa-plus-circle text-teal-600"></i>
            <span>Add Board Details</span>
        </h2>
        <input type="hidden" id="board-id">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Address -->
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-1">Address (Municipality)</label>
                <input type="text" id="address" placeholder="Enter municipality name to search" 
                       class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                <div id="municipality-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-48 overflow-y-auto hidden">
                    <ul id="municipality-list" class="text-sm text-gray-700"></ul>
                </div>
                <input type="hidden" id="municipality-id">
            </div>

            <!-- Shop Name -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Shop Name</label>
                <input type="text" id="shop_name" placeholder="Enter shop name" 
                       class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
            </div>

            <!-- Brand -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
                <select id="brand" class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                    <option value="">Select Brand</option>
                </select>
            </div>

            <!-- Board Type -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Board Type</label>
                <select id="board_type" class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                    <option value="">Select Board Type</option>
                </select>
            </div>

            <!-- Dimensions -->
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Length (ft)</label>
                    <input type="number" id="length_feet" min="0" step="0.1" placeholder="0" 
                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Width (ft)</label>
                    <input type="number" id="breadth_feet" min="0" step="0.1" placeholder="0" 
                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                </div>
            </div>

            <!-- Quantity -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                <input type="number" id="quantity" min="1" value="1" 
                       class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
            </div>

            <!-- Rate -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Rate (NPR/sqft)</label>
                <input type="number" id="rate" min="0" step="0.01" placeholder="0.00" readonly
                       class="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-sm">
            </div>

            <!-- Discount -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Discount (NPR)</label>
                <input type="number" id="discount" min="0" step="0.01" placeholder="0.00" 
                       class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
            </div>

            <!-- Image Upload -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Board Image</label>
                <input type="file" id="board_image" accept="image/*" 
                       class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
            </div>
        </div>

        <!-- Calculated Fields -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Total Area (sqft)</label>
                <input type="text" id="total_area" readonly 
                       class="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Total Amount (NPR)</label>
                <input type="text" id="total_amount" readonly 
                       class="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-sm font-semibold">
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3 mt-6">
            <button id="save-board-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium transition-colors flex items-center space-x-2">
                <i class="fas fa-save"></i>
                <span>Save Board</span>
            </button>
            <button id="clear-form-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md font-medium transition-colors flex items-center space-x-2">
                <i class="fas fa-eraser"></i>
                <span>Clear</span>
            </button>
        </div>
    </div>

    <!-- Board Table -->
    <div class="bg-white rounded-lg shadow-md p-6 border border-gray-100">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
            <i class="fas fa-table text-teal-600"></i>
            <span>Board Details</span>
        </h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm border-collapse">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Address</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Shop</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Brand</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Type</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Dimensions</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Area</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Qty</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Rate</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Discount</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Total</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Paid</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Status</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-600 border-b">Actions</th>
                    </tr>
                </thead>
                <tbody id="board-table-body" class="divide-y divide-gray-200">
                    <tr id="no-data-row">
                        <td colspan="13" class="px-4 py-6 text-center text-gray-500">
                            <i class="fas fa-inbox text-2xl mb-2"></i>
                            <p>No boards added yet</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <div class="mt-4 flex justify-between items-center">
            <div>
                <span id="pagination-info" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex space-x-2">
                <button id="prev-page" class="bg-gray-300 hover:bg-gray-400 text-gray-700 py-1 px-3 rounded-md disabled:opacity-50" disabled>Previous</button>
                <button id="next-page" class="bg-gray-300 hover:bg-gray-400 text-gray-700 py-1 px-3 rounded-md disabled:opacity-50" disabled>Next</button>
            </div>
        </div>
    </div>

    <!-- Add Municipality Modal -->
    <div id="municipality-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="municipality-modal-title" class="text-lg font-semibold text-gray-900">Add Municipality</h3>
                <button id="close-municipality-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Municipality Name</label>
                    <input type="text" id="new-municipality" placeholder="e.g., Kathmandu" 
                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm">
                    <input type="hidden" id="municipality-id">
                </div>
                <div class="flex space-x-3 pt-4">
                    <button id="save-municipality" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
                        Save Municipality
                    </button>
                    <button id="cancel-municipality" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-md font-medium transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Existing Municipalities</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Name</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="municipality-table" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Board Type Modal -->
    <div id="board-type-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="board-type-modal-title" class="text-lg font-semibold text-gray-900">Add Board Type</h3>
                <button id="close-board-type-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Board Type Name</label>
                    <input type="text" id="new-board-type" placeholder="e.g., Digital LED" 
                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <input type="hidden" id="board-type-id">
                </div>
                <div class="flex space-x-3 pt-4">
                    <button id="save-board-type" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
                        Save Board Type
                    </button>
                    <button id="cancel-board-type" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-md font-medium transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Existing Board Types</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Name</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="board-type-table" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Set Board Type Rate Modal -->
    <div id="rate-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z:50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Set Board Type Rate</h3>
                <button id="close-rate-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Board Type</label>
                    <select id="rate-board-type" class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                        <option value="">Select Board Type</option>
                    </select>
                </div>
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Municipality</label>
                    <input type="text" id="rate-municipality" placeholder="Enter municipality name to search" 
                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                    <div id="rate-municipality-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-48 overflow-y-auto hidden">
                        <ul id="rate-municipality-list" class="text-sm text-gray-700"></ul>
                    </div>
                    <input type="hidden" id="rate-municipality-id">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rate per sqft (NPR)</label>
                    <input type="number" id="new-rate" min="0" step="0.01" placeholder="0.00" 
                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                </div>
                <div class="flex space-x-3 pt-4">
                    <button id="save-rate" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
                        Save Rate
                    </button>
                    <button id="cancel-rate" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-md font-medium transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Existing Rates</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Board Type</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Municipality</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Rate (NPR/sqft)</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rate-table" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Brand Modal -->
    <div id="brand-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add Brand</h3>
                <button id="close-brand-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Client</label>
                    <select id="brand-client-select" class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm">
                        <option value="">Select Client</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Brand Name</label>
                    <input type="text" id="new-brand-name" placeholder="e.g., Premium Banking" 
                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm">
                </div>
                <div class="flex space-x-3 pt-4">
                    <button id="save-brand" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
                        Save Brand
                    </button>
                    <button id="cancel-brand" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-md font-medium transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Apply Payment/Discount Modal -->
    <div id="payment-discount-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Apply Payment/Discount</h3>
                <button id="close-payment-discount-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="payment-board-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Amount (NPR)</label>
                    <input type="number" id="payment-amount" min="0" step="0.01" placeholder="0.00" 
                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Discount Amount (NPR)</label>
                    <input type="number" id="discount-amount" min="0" step="0.01" placeholder="0.00" 
                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm">
                </div>
                <div class="flex space-x-3 pt-4">
                    <button id="apply-payment-discount" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
                        Apply
                    </button>
                    <button id="cancel-payment-discount" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-md font-medium transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentClientId = null;
    let currentPage = 1;
    const boardsPerPage = 10;

    // DOM elements
    const clientIdInput = document.getElementById('client_id');
    const clientNameInput = document.getElementById('client_name');
    const clientDropdown = document.getElementById('client-dropdown');
    const clientList = document.getElementById('client-list');
    const searchClientBtn = document.getElementById('search-client-btn');
    const clientInfo = document.getElementById('client-info');
    const clientNameSpan = document.getElementById('client-name');
    const boardFormContainer = document.getElementById('board-form-container');
    const boardFormTitle = document.getElementById('board-form-title');
    const boardIdInput = document.getElementById('board-id');
    const addressInput = document.getElementById('address');
    const municipalityDropdown = document.getElementById('municipality-dropdown');
    const municipalityList = document.getElementById('municipality-list');
    const shopNameInput = document.getElementById('shop_name');
    const brandSelect = document.getElementById('brand');
    const boardTypeSelect = document.getElementById('board_type');
    const lengthFeetInput = document.getElementById('length_feet');
    const breadthFeetInput = document.getElementById('breadth_feet');
    const quantityInput = document.getElementById('quantity');
    const rateInput = document.getElementById('rate');
    const discountInput = document.getElementById('discount');
    const boardImageInput = document.getElementById('board_image');
    const totalAreaInput = document.getElementById('total_area');
    const totalAmountInput = document.getElementById('total_amount');
    const saveBoardBtn = document.getElementById('save-board-btn');
    const clearFormBtn = document.getElementById('clear-form-btn');
    const boardTableBody = document.getElementById('board-table-body');
    const totalBoardsSpan = document.getElementById('total-boards');
    const totalDuesSpan = document.getElementById('total-dues');
    const totalPaidSpan = document.getElementById('total-paid');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const paginationInfo = document.getElementById('pagination-info');
    const addMunicipalityBtn = document.getElementById('add-municipality-btn');
    const addBoardTypeBtn = document.getElementById('add-board-type-btn');
    const setRateBtn = document.getElementById('set-rate-btn');
    const addBrandBtn = document.getElementById('add-brand-btn');
    const municipalityModal = document.getElementById('municipality-modal');
    const boardTypeModal = document.getElementById('board-type-modal');
    const rateModal = document.getElementById('rate-modal');
    const brandModal = document.getElementById('brand-modal');
    const paymentDiscountModal = document.getElementById('payment-discount-modal');
    const municipalityModalTitle = document.getElementById('municipality-modal-title');
    const boardTypeModalTitle = document.getElementById('board-type-modal-title');
    const municipalityIdInput = document.getElementById('municipality-id');
    const newMunicipalityInput = document.getElementById('new-municipality');
    const municipalityTable = document.getElementById('municipality-table');
    const boardTypeIdInput = document.getElementById('board-type-id');
    const newBoardTypeInput = document.getElementById('new-board-type');
    const boardTypeTable = document.getElementById('board-type-table');
    const rateBoardTypeSelect = document.getElementById('rate-board-type');
    const rateMunicipalityInput = document.getElementById('rate-municipality');
    const rateMunicipalityIdInput = document.getElementById('rate-municipality-id');
    const rateMunicipalityDropdown = document.getElementById('rate-municipality-dropdown');
    const rateMunicipalityList = document.getElementById('rate-municipality-list');
    const newRateInput = document.getElementById('new-rate');
    const rateTable = document.getElementById('rate-table');
    const brandClientSelect = document.getElementById('brand-client-select');
    const newBrandNameInput = document.getElementById('new-brand-name');
    const paymentBoardIdInput = document.getElementById('payment-board-id');
    const paymentAmountInput = document.getElementById('payment-amount');
    const discountAmountInput = document.getElementById('discount-amount');

    // Calculate area and amount
    function calculateAreaAndAmount() {
        const length = parseFloat(lengthFeetInput.value) || 0;
        const breadth = parseFloat(breadthFeetInput.value) || 0;
        const quantity = parseInt(quantityInput.value) || 1;
        const rate = parseFloat(rateInput.value) || 0;
        const discount = parseFloat(discountInput.value) || 0;

        const area = length * breadth;
        const totalAmount = (area * quantity * rate) - discount;

        totalAreaInput.value = area.toFixed(2);
        totalAmountInput.value = totalAmount < 0 ? '0.00' : totalAmount.toFixed(2);
    }

    // Fetch municipalities for dropdown
    async function populateMunicipalityDropdown(searchTerm) {
        try {
            const response = await fetch(`/client-management/municipalities/?search=${encodeURIComponent(searchTerm)}`);
            const municipalities = await response.json();
            municipalityList.innerHTML = '';
            if (municipalities.length === 0) {
                municipalityDropdown.classList.add('hidden');
                return;
            }
            municipalities.forEach(municipality => {
                const li = document.createElement('li');
                li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                li.textContent = municipality.name;
                li.dataset.municipalityId = municipality.id;
                li.addEventListener('click', () => {
                    addressInput.value = municipality.name;
                    municipalityIdInput.value = municipality.municipalityId;
                    municipalityDropdown.classList.add('hidden');
                    updateRate();
                });
                municipalityList.appendChild(li);
            });
            municipalityDropdown.classList.remove('hidden');
        } catch (error) {
            console.error('Error fetching municipalities:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load municipalities',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Fetch municipalities for rate modal dropdown
    async function populateRateMunicipalityDropdown(searchTerm) {
        try {
            const response = await fetch(`/client-management/municipalities/?search=${encodeURIComponent(searchTerm)}`);
            const municipalities = await response.json();
            rateMunicipalityList.innerHTML = '';
            if (municipalities.length === 0) {
                rateMunicipalityDropdown.classList.add('hidden');
                return;
            }
            municipalities.forEach(municipality => {
                const li = document.createElement('li');
                li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                li.textContent = municipality.name;
                li.dataset.municipalityId = municipality.id;
                li.addEventListener('click', () => {
                    rateMunicipalityInput.value = municipality.name;
                    rateMunicipalityIdInput.value = municipality.id;
                    rateMunicipalityDropdown.classList.add('hidden');
                });
                rateMunicipalityList.appendChild(li);
            });
            rateMunicipalityDropdown.classList.remove('hidden');
        } catch (error) {
            console.error('Error fetching municipalities:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load municipalities',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Update rate based on board type and municipality
    async function updateRate() {
        const boardTypeId = boardTypeSelect.value;
        const municipalityId = municipalityIdInput.value;
        if (boardTypeId && municipalityId) {
            try {
                const response = await fetch(`/client-management/board-type-rate/?board_type_id=${boardTypeId}&municipality_id=${municipalityId}`);
                const data = await response.json();
                if (data.success) {
                    rateInput.value = parseFloat(data.rate).toFixed(2);
                    calculateAreaAndAmount();
                } else {
                    rateInput.value = '0.00';
                    Swal.fire({
                        icon: 'warning',
                        title: 'No Rate Found',
                        text: 'No rate set for this board type and municipality',
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    });
                }
            } catch (error) {
                console.error('Error fetching rate:', error);
                rateInput.value = '0.00';
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load rate',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        } else {
            rateInput.value = '0.00';
        }
        calculateAreaAndAmount();
    }

    // Fetch and update board type dropdown
    async function updateBoardTypeDropdown() {
        try {
            const response = await fetch('/client-management/board-types/');
            const boardTypes = await response.json();
            boardTypeSelect.innerHTML = '<option value="">Select Board Type</option>';
            rateBoardTypeSelect.innerHTML = '<option value="">Select Board Type</option>';
            boardTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                boardTypeSelect.appendChild(option.cloneNode(true));
                rateBoardTypeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching board types:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load board types',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Fetch and update brand dropdown
    async function updateBrandDropdown(clientId) {
        brandSelect.innerHTML = '<option value="">Select Brand</option>';
        if (clientId) {
            try {
                const response = await fetch(`/client-management/brands/${clientId}/`);
                const brands = await response.json();
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.id;
                    option.textContent = brand.name;
                    brandSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching brands:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load brands',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        }
        calculateAreaAndAmount();
    }

    // Fetch and update brand client select in modal
    async function updateBrandClientSelect() {
        try {
            const response = await fetch('/client-management/clients/');
            const clients = await response.json();
            brandClientSelect.innerHTML = '<option value="">Select Client</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                brandClientSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching clients:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load clients',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Fetch and update municipality table
    async function updateMunicipalityTable() {
        try {
            const response = await fetch('/client-management/municipalities/');
            const municipalities = await response.json();
            municipalityTable.innerHTML = '';
            municipalities.forEach(municipality => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 text-gray-600">${municipality.name}</td>
                    <td class="px-4 py-2">
                        <button class="edit-municipality text-blue-600 hover:text-blue-800 mr-2" data-id="${municipality.id}" data-name="${municipality.name}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-municipality text-red-600 hover:text-red-800" data-id="${municipality.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                municipalityTable.appendChild(row);
            });
            document.querySelectorAll('.edit-municipality').forEach(button => {
                button.addEventListener('click', () => {
                    municipalityIdInput.value = button.dataset.id;
                    newMunicipalityInput.value = button.dataset.name;
                    municipalityModalTitle.textContent = 'Edit Municipality';
                });
            });
            document.querySelectorAll('.delete-municipality').forEach(button => {
                button.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this municipality?')) {
                        try {
                            const response = await fetch(`/client-management/municipalities/delete/${button.dataset.id}/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}',
                                    'Content-Type': 'application/json'
                                }
                            });
                            const data = await response.json();
                            if (data.success) {
                                updateMunicipalityTable();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Deleted',
                                    text: 'Municipality deleted successfully',
                                    timer: 1500,
                                    timerProgressBar: true,
                                    showConfirmButton: false
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message || 'Failed to delete municipality',
                                    timer: 2000,
                                    timerProgressBar: true,
                                    showConfirmButton: false
                                });
                            }
                        } catch (error) {
                            console.error('Error deleting municipality:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to delete municipality',
                                timer: 2000,
                                timerProgressBar: true,
                                showConfirmButton: false
                            });
                        }
                    }
                });
            });
        } catch (error) {
            console.error('Error fetching municipalities:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load municipalities',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Fetch and update board type table
    async function updateBoardTypeTable() {
        try {
            const response = await fetch('/client-management/board-types/');
            const boardTypes = await response.json();
            boardTypeTable.innerHTML = '';
            boardTypes.forEach(type => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 text-gray-600">${type.name}</td>
                    <td class="px-4 py-2">
                        <button class="edit-board-type text-blue-600 hover:text-blue-800 mr-2" data-id="${type.id}" data-name="${type.name}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-board-type text-red-600 hover:text-red-800" data-id="${type.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                boardTypeTable.appendChild(row);
            });
            document.querySelectorAll('.edit-board-type').forEach(button => {
                button.addEventListener('click', () => {
                    boardTypeIdInput.value = button.dataset.id;
                    newBoardTypeInput.value = button.dataset.name;
                    boardTypeModalTitle.textContent = 'Edit Board Type';
                });
            });
            document.querySelectorAll('.delete-board-type').forEach(button => {
                button.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this board type?')) {
                        try {
                            const response = await fetch(`/client-management/board-types/delete/${button.dataset.id}/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}',
                                    'Content-Type': 'application/json'
                                }
                            });
                            const data = await response.json();
                            if (data.success) {
                                updateBoardTypeTable();
                                updateBoardTypeDropdown();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Deleted',
                                    text: 'Board type deleted successfully',
                                    timer: 1500,
                                    timerProgressBar: true,
                                    showConfirmButton: false
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message || 'Failed to delete board type',
                                    timer: 2000,
                                    timerProgressBar: true,
                                    showConfirmButton: false
                                });
                            }
                        } catch (error) {
                            console.error('Error deleting board type:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to delete board type',
                                timer: 2000,
                                timerProgressBar: true,
                                showConfirmButton: false
                            });
                        }
                    }
                });
            });
        } catch (error) {
            console.error('Error fetching board types:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load board types',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Fetch and update rate table
    async function updateRateTable() {
        try {
            const response = await fetch('/client-management/board-type-rates/');
            const rates = await response.json();
            rateTable.innerHTML = '';
            rates.forEach(rate => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 text-gray-600">${rate.board_type_name}</td>
                    <td class="px-4 py-2 text-gray-600">${rate.municipality_name}</td>
                    <td class="px-4 py-2 text-gray-600">NPR ${parseFloat(rate.rate).toFixed(2)}</td>
                    <td class="px-4 py-2">
                        <button class="edit-rate text-blue-600 hover:text-blue-800 mr-2" data-board-type-id="${rate.board_type_id}" data-municipality-id="${rate.municipality_id}" data-rate="${rate.rate}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-rate text-red-600 hover:text-red-800" data-board-type-id="${rate.board_type_id}" data-municipality-id="${rate.municipality_id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                rateTable.appendChild(row);
            });
            document.querySelectorAll('.edit-rate').forEach(button => {
                button.addEventListener('click', () => {
                    rateBoardTypeSelect.value = button.dataset.boardTypeId;
                    rateMunicipalityIdInput.value = button.dataset.municipalityId;
                    rateMunicipalityInput.value = button.parentElement.previousElementSibling.previousElementSibling.textContent;
                    newRateInput.value = button.dataset.rate;
                });
            });
            document.querySelectorAll('.delete-rate').forEach(button => {
                button.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this rate?')) {
                        try {
                            const response = await fetch('/client-management/board-type-rates/delete/', {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    board_type_id: button.dataset.boardTypeId,
                                    municipality_id: button.dataset.municipalityId
                                })
                            });
                            const data = await response.json();
                            if (data.success) {
                                updateRateTable();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Deleted',
                                    text: 'Rate deleted successfully',
                                    timer: 1500,
                                    timerProgressBar: true,
                                    showConfirmButton: false
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message || 'Failed to delete rate',
                                    timer: 2000,
                                    timerProgressBar: true,
                                    showConfirmButton: false
                                });
                            }
                        } catch (error) {
                            console.error('Error deleting rate:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to delete rate',
                                timer: 2000,
                                timerProgressBar: true,
                                showConfirmButton: false
                            });
                        }
                    }
                });
            });
        } catch (error) {
            console.error('Error fetching rates:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load rates',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Fetch boards with pagination
    async function fetchBoards(clientId, page = 1) {
        try {
            const response = await fetch(`/client-management/boards/${clientId}/?page=${page}&per_page=${boardsPerPage}`);
            const data = await response.json();
            if (data.success) {
                updateBoardTable(data.boards);
                updatePagination(data.pagination);
                updateFinancialSummary(data.financial_summary);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to load boards',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        } catch (error) {
            console.error('Error fetching boards:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load boards',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Update board table
    function updateBoardTable(boards) {
        boardTableBody.innerHTML = '';
        if (boards.length === 0) {
            boardTableBody.innerHTML = `
                <tr id="no-data-row">
                    <td colspan="13" class="px-4 py-6 text-center text-gray-500">
                        <i class="fas fa-inbox text-2xl mb-2"></i>
                        <p>No boards added yet</p>
                    </td>
                </tr>
            `;
            return;
        }

        boards.forEach(board => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors';
            row.innerHTML = `
                <td class="px-4 py-2 text-gray-600 border-b">${board.address}</td>
                <td class="px-4 py-2 text-gray-600 border-b">${board.shop_name}</td>
                <td class="px-4 py-2 text-gray-600 border-b">${board.brand_name}</td>
                <td class="px-4 py-2 border-b">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getBoardTypeColor(board.board_type_name)}">${board.board_type_name}</span>
                </td>
                <td class="px-4 py-2 text-gray-600 border-b">${parseFloat(board.length).toFixed(2)} × ${parseFloat(board.breadth).toFixed(2)} ft</td>
                <td class="px-4 py-2 text-gray-600 border-b">${parseFloat(board.area).toFixed(2)} sqft</td>
                <td class="px-4 py-2 text-gray-600 border-b">${board.quantity}</td>
                <td class="px-4 py-2 text-gray-600 border-b">NPR ${parseFloat(board.rate).toFixed(2)}</td>
                <td class="px-4 py-2 text-gray-600 border-b">NPR ${parseFloat(board.discount).toFixed(2)}</td>
                <td class="px-4 py-2 text-gray-900 font-semibold border-b">NPR ${parseFloat(board.total_amount).toFixed(2)}</td>
                <td class="px-4 py-2 text-gray-600 border-b">NPR ${parseFloat(board.paid_amount).toFixed(2)}</td>
                <td class="px-4 py-2 text-gray-600 border-b">${board.status}</td>
                <td class="px-4 py-2 border-b">
                    <button class="edit-board text-blue-600 hover:text-blue-800 mr-2" data-id="${board.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-board text-red-600 hover:text-red-800 mr-2" data-id="${board.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="apply-payment-discount text-teal-600 hover:text-teal-800" data-id="${board.id}">
                        <i class="fas fa-dollar-sign"></i>
                    </button>
                </td>
            `;
            boardTableBody.appendChild(row);
        });

        // Bind edit, delete, and payment/discount buttons
        document.querySelectorAll('.edit-board').forEach(button => {
            button.addEventListener('click', () => editBoard(button.dataset.id));
        });
        document.querySelectorAll('.delete-board').forEach(button => {
            button.addEventListener('click', () => deleteBoard(button.dataset.id));
        });
        document.querySelectorAll('.apply-payment-discount').forEach(button => {
            button.addEventListener('click', () => openPaymentDiscountModal(button.dataset.id));
        });
    }

    // Update financial summary
    function updateFinancialSummary(summary) {
        console.log('Financial Summary:', summary);
        document.getElementById('total-boards').textContent = summary.total_boards || 0;
        document.getElementById('previous-dues').textContent = (parseFloat(summary.previous_dues) || 0).toFixed(2);
        document.getElementById('total-value').textContent = (parseFloat(summary.current_year_total) || 0).toFixed(2);
        document.getElementById('total-dues').textContent = (parseFloat(summary.total_dues) || 0).toFixed(2);
        document.getElementById('total-discount').textContent = (parseFloat(summary.total_discount) || 0).toFixed(2);
        document.getElementById('total-paid').textContent = (parseFloat(summary.total_paid) || 0).toFixed(2);
        document.getElementById('total-remaining').textContent = (parseFloat(summary.total_remaining) || 0).toFixed(2);
    }

    // Update pagination
    function updatePagination(pagination) {
        currentPage = pagination.current_page;
        const totalPages = pagination.total_pages;
        paginationInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
    }

    // Edit board
    async function editBoard(boardId) {
        try {
            const response = await fetch(`/client-management/board/${boardId}/`);
            const data = await response.json();
            if (data.success) {
                const board = data.board;
                boardIdInput.value = board.id;
                addressInput.value = board.address;
                municipalityIdInput.value = board.municipality_id;
                shopNameInput.value = board.shop_name;
                brandSelect.value = board.brand_id;
                boardTypeSelect.value = board.board_type_id;
                lengthFeetInput.value = board.length;
                breadthFeetInput.value = board.breadth;
                quantityInput.value = board.quantity;
                rateInput.value = board.rate;
                discountInput.value = board.discount;
                boardFormTitle.textContent = 'Edit Board Details';
                saveBoardBtn.querySelector('span').textContent = 'Update Board';
                boardFormContainer.classList.remove('hidden');
                calculateAreaAndAmount();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to load board details',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        } catch (error) {
            console.error('Error fetching board:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load board details',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Delete board
    async function deleteBoard(boardId) {
        Swal.fire({
            title: 'Delete Board?',
            text: "This action cannot be undone",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/client-management/board/delete/${boardId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (data.success) {
                        fetchBoards(currentClientId, currentPage);
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted',
                            text: 'Board has been deleted successfully',
                            timer: 1500,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message || 'Failed to delete board',
                            timer: 2000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                    }
                } catch (error) {
                    console.error('Error deleting board:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to delete board',
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    });
                }
            }
        });
    }

    // Open payment/discount modal
    function openPaymentDiscountModal(boardId) {
        paymentBoardIdInput.value = boardId;
        paymentAmountInput.value = '';
        discountAmountInput.value = '';
        paymentDiscountModal.classList.remove('hidden');
    }

    // Search client
    async function searchClient(clientId) {
        if (!clientId) {
            Swal.fire({
                icon: 'warning',
                title: 'Missing Client ID',
                text: 'Please enter a client ID or select a client from the dropdown',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
            return;
        }

        try {
            const response = await fetch(`/client-management/client/${clientId}/`);
            const data = await response.json();
            if (data.success) {
                currentClientId = clientId;
                clientNameSpan.textContent = data.client.name;
                clientInfo.classList.remove('hidden');
                boardFormContainer.classList.remove('hidden');
                updateBrandDropdown(clientId);
                fetchBoards(clientId, 1);
                clientIdInput.value = '';
                clientNameInput.value = '';
                clientDropdown.classList.add('hidden');
                Swal.fire({
                    icon: 'success',
                    title: 'Client Found',
                    text: `${data.client.name} selected successfully`,
                    timer: 1500,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Client Not Found',
                    text: data.message || 'Please check the client ID or name and try again',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
                clientInfo.classList.add('hidden');
                boardFormContainer.classList.add('hidden');
                currentClientId = null;
                boardTableBody.innerHTML = `
                    <tr id="no-data-row">
                        <td colspan="13" class="px-4 py-6 text-center text-gray-500">
                            <i class="fas fa-inbox text-2xl mb-2"></i>
                            <p>No boards added yet</p>
                        </td>
                    </tr>
                `;
                updateFinancialSummary({});
            }
        } catch (error) {
            console.error('Error searching client:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to search client',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Populate client dropdown
    async function populateClientDropdown(searchTerm) {
        try {
            const response = await fetch(`/client-management/clients/?search=${encodeURIComponent(searchTerm)}`);
            const clients = await response.json();
            clientList.innerHTML = '';
            if (clients.length === 0) {
                clientDropdown.classList.add('hidden');
                return;
            }
            clients.forEach(client => {
                const li = document.createElement('li');
                li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                li.textContent = client.name;
                li.dataset.clientId = client.id;
                li.addEventListener('click', () => searchClient(client.id));
                clientList.appendChild(li);
            });
            clientDropdown.classList.remove('hidden');
        } catch (error) {
            console.error('Error fetching clients:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load clients',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    }

    // Save board
    saveBoardBtn.addEventListener('click', async function() {
        if (!currentClientId) {
            Swal.fire({
                icon: 'error',
                title: 'No Client Selected',
                text: 'Please search and select a client first',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
            return;
        }

        const boardId = boardIdInput.value;
        const municipalityId = municipalityIdInput.value;
        const address = addressInput.value.trim();
        const shopName = shopNameInput.value.trim();
        const brandId = brandSelect.value;
        const boardTypeId = boardTypeSelect.value;
        const length = parseFloat(lengthFeetInput.value) || 0;
        const breadth = parseFloat(breadthFeetInput.value) || 0;
        const quantity = parseInt(quantityInput.value) || 1;
        const rate = parseFloat(rateInput.value) || 0;
        const discount = parseFloat(discountInput.value) || 0;
        const boardImage = boardImageInput.files[0];

        if (!municipalityId || !address || !shopName || !brandId || !boardTypeId || length <= 0 || breadth <= 0 || rate <= 0) {
            Swal.fire({
                icon: 'error',
                title: 'Incomplete Information',
                text: 'Please fill in all required fields, including selecting a municipality',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
            return;
        }

        const formData = new FormData();
        formData.append('client_id', currentClientId);
        formData.append('municipality_id', municipalityId);
        formData.append('address', address);
        formData.append('shop_name', shopName);
        formData.append('brand_id', brandId);
        formData.append('board_type_id', boardTypeId);
        formData.append('length', length);
        formData.append('breadth', breadth);
        formData.append('quantity', quantity);
        formData.append('rate', rate);
        formData.append('discount', discount);
        if (boardImage) formData.append('image', boardImage);
        if (boardId) formData.append('id', boardId);

        console.log('FormData:', Object.fromEntries(formData));

        try {
            const response = await fetch('/client-management/board/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });
            const data = await response.json();
            console.log('Response:', data);
            if (data.success) {
                fetchBoards(currentClientId, currentPage);
                clearForm();
                Swal.fire({
                    icon: 'success',
                    title: boardId ? 'Board Updated' : 'Board Added',
                    text: `Board has been ${boardId ? 'updated' : 'added'} successfully`,
                    timer: 1500,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to save board',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        } catch (error) {
            console.error('Error saving board:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to save board',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    });

    // Save municipality
    document.getElementById('save-municipality').addEventListener('click', async function() {
        const municipalityId = municipalityIdInput.value;
        const name = newMunicipalityInput.value.trim();

        if (!name) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Input',
                text: 'Please enter a municipality name',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
            return;
        }

        try {
            const response = await fetch('/client-management/municipalities/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    id: municipalityId,
                    name: name
                })
            });
            const data = await response.json();
            if (data.success) {
                updateMunicipalityTable();
                municipalityModal.classList.add('hidden');
                municipalityIdInput.value = '';
                newMunicipalityInput.value = '';
                municipalityModalTitle.textContent = 'Add Municipality';
                Swal.fire({
                    icon: 'success',
                    title: municipalityId ? 'Municipality Updated' : 'Municipality Added',
                    text: `${name} has been ${municipalityId ? 'updated' : 'added'} successfully`,
                    timer: 1500,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to save municipality',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        } catch (error) {
            console.error('Error saving municipality:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to save municipality',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    });

    // Save board type
    document.getElementById('save-board-type').addEventListener('click', async function() {
        const boardTypeId = boardTypeIdInput.value;
        const typeName = newBoardTypeInput.value.trim();

        if (!typeName) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Input',
                text: 'Please enter a valid board type name',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
            return;
        }

        try {
            const response = await fetch('/client-management/board-types/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    id: boardTypeId,
                    name: typeName
                })
            });
            const data = await response.json();
            if (data.success) {
                updateBoardTypeTable();
                updateBoardTypeDropdown();
                boardTypeModal.classList.add('hidden');
                boardTypeIdInput.value = '';
                newBoardTypeInput.value = '';
                boardTypeModalTitle.textContent = 'Add Board Type';
                Swal.fire({
                    icon: 'success',
                    title: boardTypeId ? 'Board Type Updated' : 'Board Type Added',
                    text: `${typeName} has been ${boardTypeId ? 'updated' : 'added'} successfully`,
                    timer: 1500,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to save board type',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        } catch (error) {
            console.error('Error saving board type:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to save board type',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    });

    // Save rate
    document.getElementById('save-rate').addEventListener('click', async function() {
        const boardTypeId = rateBoardTypeSelect.value;
        const municipalityId = rateMunicipalityIdInput.value;
        const rate = parseFloat(newRateInput.value) || 0;

        if (!boardTypeId || !municipalityId || rate <= 0) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Input',
                text: 'Please select a board type, municipality, and enter a valid rate',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
            return;
        }

        try {
            const response = await fetch('/client-management/board-type-rates/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    board_type_id: boardTypeId,
                    municipality_id: municipalityId,
                    rate: rate
                })
            });
            const data = await response.json();
            if (data.success) {
                updateRateTable();
                rateModal.classList.add('hidden');
                rateBoardTypeSelect.value = '';
                rateMunicipalityIdInput.value = '';
                rateMunicipalityInput.value = '';
                newRateInput.value = '';
                Swal.fire({
                    icon: 'success',
                    title: 'Rate Set',
                    text: 'Rate has been set successfully',
                    timer: 1500,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to save rate',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        } catch (error) {
            console.error('Error saving rate:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to save rate',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    });

// Apply payment/discount
    document.getElementById('apply-payment-discount').addEventListener('click', async function() {
        const boardId = paymentBoardIdInput.value;
        const payment = parseFloat(paymentAmountInput.value) || 0;
        const discount = parseFloat(discountAmountInput.value) || 0;

        if (payment < 0 || discount < 0) {
            Swal.fire({                icon: 'error',
                title: 'Invalid Input',
                text: 'Payment and discount amounts cannot be negative',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
            return;
        }

        try {
            const response = await fetch('/client-management/apply-payment-discount/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    board_id: boardId,
                    payment_amount: payment,
                    discount_amount: discount
                })
            });
            const data = await response.json();
            if (data.success) {
                paymentDiscountModal.classList.add('hidden');
                paymentBoardIdInput.value = '';
                paymentAmountInput.value = '';
                discountAmountInput.value = '';
                fetchBoards(currentClientId, currentPage);
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Payment/Discount applied successfully',
                    timer: 1500,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to apply payment/discount',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        } catch (error) {
            console.error('Error applying payment/discount:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to apply payment/discount',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    });

    // Save brand
    document.getElementById('save-brand').addEventListener('click', async function() {
        const clientId = brandClientSelect.value;
        const brandName = newBrandNameInput.value.trim();

        if (!clientId || !brandName) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Input',
                text: 'Please select a client and enter a brand name',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
            return;
        }

        try {
            const response = await fetch('/client-management/brands/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    client_id: clientId,
                    name: brandName
                })
            });
            const data = await response.json();
            if (data.success) {
                brandModal.classList.add('hidden');
                brandClientSelect.value = '';
                newBrandNameInput.value = '';
                if (currentClientId) {
                    updateBrandDropdown(currentClientId);
                }
                Swal.fire({
                    icon: 'success',
                    title: 'Brand Added',
                    text: `${brandName} has been added successfully`,
                    timer: 1500,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to save brand',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        } catch (error) {
            console.error('Error saving brand:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to save brand',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    });

    // Clear form
    clearFormBtn.addEventListener('click', function() {
        clearForm();
    });

    function clearForm() {
        boardIdInput.value = '';
        addressInput.value = '';
        municipalityIdInput.value = '';
        shopNameInput.value = '';
        brandSelect.value = '';
        boardTypeSelect.value = '';
        lengthFeetInput.value = '';
        breadthFeetInput.value = '';
        quantityInput.value = '1';
        rateInput.value = '0.00';
        discountInput.value = '0.00';
        boardImageInput.value = '';
        totalAreaInput.value = '';
        totalAmountInput.value = '';
        boardFormTitle.textContent = 'Add Board Details';
        saveBoardBtn.querySelector('span').textContent = 'Save Board';
        municipalityDropdown.classList.add('hidden');
    }

    // Client search input
    clientNameInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        if (searchTerm.length > 0) {
            populateClientDropdown(searchTerm);
        } else {
            clientDropdown.classList.add('hidden');
        }
    });

    // Municipality search input
    addressInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        if (searchTerm.length > 0) {
            populateMunicipalityDropdown(searchTerm);
        } else {
            municipalityDropdown.classList.add('hidden');
        }
    });

    // Rate municipality search input
    rateMunicipalityInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        if (searchTerm.length > 0) {
            populateRateMunicipalityDropdown(searchTerm);
        } else {
            rateMunicipalityDropdown.classList.add('hidden');
        }
    });

    // Update rate on board type or municipality change
    boardTypeSelect.addEventListener('change', updateRate);
    addressInput.addEventListener('change', updateRate);

    // Calculate area and amount on input change
    lengthFeetInput.addEventListener('input', calculateAreaAndAmount);
    breadthFeetInput.addEventListener('input', calculateAreaAndAmount);
    quantityInput.addEventListener('input', calculateAreaAndAmount);
    discountInput.addEventListener('input', calculateAreaAndAmount);

    // Search client button
    searchClientBtn.addEventListener('click', function() {
        const clientId = clientIdInput.value.trim();
        if (clientId) {
            searchClient(clientId);
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'Missing Client ID',
                text: 'Please enter a client ID or select a client from the dropdown',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    });

    // Pagination buttons
    prevPageBtn.addEventListener('click', function() {
        if (currentPage > 1) {
            fetchBoards(currentClientId, currentPage - 1);
        }
    });

    nextPageBtn.addEventListener('click', function() {
        fetchBoards(currentClientId, currentPage + 1);
    });

    // Modal controls
    addMunicipalityBtn.addEventListener('click', function() {
        municipalityModal.classList.remove('hidden');
        updateMunicipalityTable();
    });

    addBoardTypeBtn.addEventListener('click', function() {
        boardTypeModal.classList.remove('hidden');
        updateBoardTypeTable();
    });

    setRateBtn.addEventListener('click', function() {
        rateModal.classList.remove('hidden');
        updateRateTable();
    });

    addBrandBtn.addEventListener('click', function() {
        brandModal.classList.remove('hidden');
        updateBrandClientSelect();
    });

    document.getElementById('close-municipality-modal').addEventListener('click', function() {
        municipalityModal.classList.add('hidden');
        municipalityIdInput.value = '';
        newMunicipalityInput.value = '';
        municipalityModalTitle.textContent = 'Add Municipality';
    });

    document.getElementById('cancel-municipality').addEventListener('click', function() {
        municipalityModal.classList.add('hidden');
        municipalityIdInput.value = '';
        newMunicipalityInput.value = '';
        municipalityModalTitle.textContent = 'Add Municipality';
    });

    document.getElementById('close-board-type-modal').addEventListener('click', function() {
        boardTypeModal.classList.add('hidden');
        boardTypeIdInput.value = '';
        newBoardTypeInput.value = '';
        boardTypeModalTitle.textContent = 'Add Board Type';
    });

    document.getElementById('cancel-board-type').addEventListener('click', function() {
        boardTypeModal.classList.add('hidden');
        boardTypeIdInput.value = '';
        newBoardTypeInput.value = '';
        boardTypeModalTitle.textContent = 'Add Board Type';
    });

    document.getElementById('close-rate-modal').addEventListener('click', function() {
        rateModal.classList.add('hidden');
        rateBoardTypeSelect.value = '';
        rateMunicipalityIdInput.value = '';
        rateMunicipalityInput.value = '';
        newRateInput.value = '';
    });

    document.getElementById('cancel-rate').addEventListener('click', function() {
        rateModal.classList.add('hidden');
        rateBoardTypeSelect.value = '';
        rateMunicipalityIdInput.value = '';
        rateMunicipalityInput.value = '';
        newRateInput.value = '';
    });

    document.getElementById('close-brand-modal').addEventListener('click', function() {
        brandModal.classList.add('hidden');
        brandClientSelect.value = '';
        newBrandNameInput.value = '';
    });

    document.getElementById('cancel-brand').addEventListener('click', function() {
        brandModal.classList.add('hidden');
        brandClientSelect.value = '';
        newBrandNameInput.value = '';
    });

    document.getElementById('close-payment-discount-modal').addEventListener('click', function() {
        paymentDiscountModal.classList.add('hidden');
        paymentBoardIdInput.value = '';
        paymentAmountInput.value = '';
        discountAmountInput.value = '';
    });

    document.getElementById('cancel-payment-discount').addEventListener('click', function() {
        paymentDiscountModal.classList.add('hidden');
        paymentBoardIdInput.value = '';
        paymentAmountInput.value = '';
        discountAmountInput.value = '';
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!clientNameInput.contains(event.target) && !clientDropdown.contains(event.target)) {
            clientDropdown.classList.add('hidden');
        }
        if (!addressInput.contains(event.target) && !municipalityDropdown.contains(event.target)) {
            municipalityDropdown.classList.add('hidden');
        }
        if (!rateMunicipalityInput.contains(event.target) && !rateMunicipalityDropdown.contains(event.target)) {
            rateMunicipalityDropdown.classList.add('hidden');
        }
    });

    // Board type color function
    function getBoardTypeColor(boardType) {
        const colors = {
            'Digital LED': 'bg-blue-100 text-blue-800',
            'Billboard': 'bg-green-100 text-green-800',
            'Poster': 'bg-yellow-100 text-yellow-800',
            'Wall Painting': 'bg-purple-100 text-purple-800'
        };
        return colors[boardType] || 'bg-gray-100 text-gray-800';
    }

    // Initialize dropdowns
    updateBoardTypeDropdown();
});
</script>

<style>
.modal-backdrop {
    backdrop-filter: blur(4px);
}
table {
    border-collapse: separate;
    border-spacing: 0;
}
th, td {
    border-bottom: 1px solid #e5e7eb;
}
th:first-child, td:first-child {
    border-left: 1px solid #e5e7eb;
}
th:last-child, td:last-child {
    border-right: 1px solid #e5e7eb;
}
th {
    border-top: 1px solid #e5e7eb;
}
</style>

{% endblock %}